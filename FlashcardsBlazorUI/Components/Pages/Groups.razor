@page "/groups"
@using FlashcardsAppContracts.Constants
@using FlashcardsAppContracts.DTOs.Responses
@using FlashcardsBlazorUI.Services
@inject GroupService GroupService
@inject AuthService AuthService
@inject IGroupNotificationService GroupNotificationService
@inject NavigationManager Navigation
@inject ITokenManager TokenManager
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer



<PageTitle>Группы карточек</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Мои группы карточек</h3>
    <button class="btn btn-success" @onclick="CreateNewGroup">
        <span class="bi bi-plus-circle"></span> Создать группу
    </button>
</div>

@if (isLoading)
{
    <p><em>Загружаю группы...</em></p>
}
else if (groups == null || !groups.Any())
{
    <div class="alert alert-info text-center">
        <h5>У вас пока нет групп карточек</h5>
        <p>Создайте первую группу для изучения карточек</p>
    </div>
}
else
{
    <div id="groups-container" class="row">
        @foreach (var group in groups.OrderBy(g => g.Order))
        {
            <div class="col-md-4 mb-3">
                <div class="card group-card" data-group-id="@group.Id" style="cursor: move;">
                    <div class="card-body">
                        <h5 class="card-title">@group.GroupName</h5>
                        <p class="card-text">
                            <small class="text-muted">Создана: @group.CreatedAt.ToString("dd.MM.yyyy")</small>
                        </p>
                        <span class="badge" style="background-color:@GetColorCode(group.GroupColor)">
                            @GetColorDisplayName(group.GroupColor)
                        </span>
                        <br /><br />
                        <button class="btn btn-primary btn-sm" @onclick="() => ViewCards(group.Id)">
                            Открыть карточки
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (showCreateForm)
{
    <FlashcardsBlazorUI.Components.Forms.CreateGroupForm
        OnCancel="() => showCreateForm = false"
        OnGroupCreated="OnGroupCreated" />
}

<div class="position-fixed trash-zone" style="bottom:30px; right:30px; z-index:1000; width:120px; height:120px;">
    <div class="card h-100 border-danger text-center" style="border-width:3px; border-style:dashed; background-color:rgba(255,255,255,0.95);">
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-danger">
            <i class="bi bi-trash" style="font-size:32px; margin-bottom:5px;"></i>
            <small>Удалить</small>
        </div>
    </div>
</div>

<DragDropInitializer />

@code {
    private List<ResultGroupDto>? groups;
    private bool isLoading = true;
    private bool showCreateForm;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            GroupNotificationService.OnGroupsReordered += RefreshGroups;
            await AuthService.InitializeAsync();
            await LoadGroups();
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки групп: {ex.Message}");
        }
    }

    private async Task LoadGroups()
    {
        isLoading = true;
        try
        {
            groups = await GroupService.GetGroupsAsync();
            Console.WriteLine($"Groups.razor: Загружено групп: {groups?.Count ?? 0}");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private void RefreshGroups(string sourceContainer)
    {
        // Обновляемся только если изменения пришли НЕ из основного окна
        if (sourceContainer == "#groups-container")
        {
            Console.WriteLine("Groups.razor: Игнорируем уведомление из собственного контейнера");
            return;
        }
        
        Console.WriteLine($"Groups.razor: RefreshGroups из {sourceContainer}");
        _ = InvokeAsync(async () =>
        {
            await LoadGroups();
            StateHasChanged();
        });
    }

    private void CreateNewGroup() => showCreateForm = true;

    private async Task OnGroupCreated()
    {
        showCreateForm = false;
        await LoadGroups();
        
        GroupNotificationService.NotifyGroupsReordered("group-created");

        await Task.Delay(100); // Небольшая задержка для рендеринга
        await ReinitializeDragDrop();

        
        Navigation.NavigateTo("/groups");
    }
    

    private async Task ReinitializeDragDrop()
    {
        try
        {
            var token = TokenManager.Token; 
            await JSRuntime.InvokeVoidAsync("dragDropInterop.initializeDragDrop",
                token,
                "#groups-container",
                ".group-card",
                "http://localhost:5153/api/group/reorder",
                ".trash-zone");
        
            Console.WriteLine("Groups: Drag and drop переинициализирован");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка переинициализации drag and drop: {ex.Message}");
        }
    }

    
    private void ViewCards(Guid groupId) =>
        Navigation.NavigateTo($"/groups/{groupId}/cards");

    private string GetColorCode(GroupColor color) => color switch
    {
        GroupColor.Red => "#dc3545",
        GroupColor.Green => "#28a745",
        GroupColor.Yellow => "#ffc107",
        GroupColor.Orange => "#fd7e14",
        GroupColor.Purple => "#6f42c1",
        GroupColor.Pink => "#e83e8c",
        GroupColor.Black => "#343a40",
        _ => "#6c757d"
    };

    private string GetColorDisplayName(GroupColor color) => color switch
    {
        GroupColor.Red => "Красный",
        GroupColor.Green => "Зеленый",
        GroupColor.Yellow => "Желтый",
        GroupColor.Orange => "Оранжевый",
        GroupColor.Purple => "Фиолетовый",
        GroupColor.Pink => "Розовый",
        GroupColor.Black => "Черный",
        _ => "Серый"
    };

    public void Dispose()
    {
        GroupNotificationService.OnGroupsReordered -= RefreshGroups;
    }
}